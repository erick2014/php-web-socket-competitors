<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>listado competidores</title>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <script>
    //this variable will contains the webSocket instance
    var conn="";
    var competitorsList=[];

    //this function append all li to the ul tag
    function drawCompetitorsOnDom(competitors){
      //clear the current list
      $(".competidores-list").html("");
      //check if we got an array
      if(competitors &&  competitors instanceof Array && competitors.length>0){
        var liElements="";
        //loop through each competitor
        for(c=0;c<competitors.length;c++){
          liElements+="<li>"+"name= "+competitors[c].name+", lastName= "+competitors[c].lastName+", score ="+competitors[c].score+"</li>";
        }
        $(".competidores-list").append(liElements);
      }
    }

    //get all competitors from server
    function getCompetitors(){
      $.ajax({
        type:'GET',
        url:"competidoresDb.php",
        dataType:'json',
        success:function(competitors){
          competitorsList=competitors;
          console.log("competitors from server",competitors)
          drawCompetitorsOnDom(competitors)
        },
        error:function(error){
          console.error("here error ",error);
        }

      })
    }

    //remember to connect through ssh and verify if the webSocket server is running on port 8080
    function connectToWebSocket(){
      conn = new WebSocket('ws://192.169.165.156:8080');
      conn.onopen = function(e) {
        console.log("Connected to webSocket!");
      };

      conn.onmessage = function(e) {
        var data=e.data;
         console.log("I have received ",data)
        //check if we got an object
        if(  typeof JSON.parse(data) ==='object' ){
          var competitor=JSON.parse(data);
          //update just the modified competitor within the array
          competitorsList[competitor.arrayIndex]["score"]=competitor.score;
          console.log("new competitors ",competitorsList)
          //update the view with the new values
          drawCompetitorsOnDom(competitorsList);
        }
        console.log(typeof lele)
      };
    }
    //stablish connection with socket
    connectToWebSocket();
    //get competitors from server file
    getCompetitors();


  </script>
</head>
  <body>
    <h1> Lista competidores </h1>
    <ul class="competidores-list"></ul>
  </body>
</html>
