<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Admin panel</title>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <style>
    .new-competitor-form{
      display: none;
    }
  </style>
</head>
<body>
  <h1>Admin panel</h1>
  <h1> Lista competidores </h1>
  <ul class="competidores-list"></ul>
  <input type="button" value="Add new competitor" id="addCompetitor">

  <div class="new-competitor-form">
    <span>Select the competitor</span>
    <select class="select-competitors">
      <option value=""></option>
    </select>
    <input type="text" class="score-competitor" placeholder="Score">
    <input type="button" class="save-competitor" value="save">
  </div>

  <script>
    //this variable will contains the webSocket instance
    var conn="";
    var competitorsList=[];

    //once the user clicks on save btn sent the update to the competitors.html page
    $(".save-competitor").click(function(){
      var competitorArrayIndex=$(".select-competitors").val();
      var competitorScore=$(".score-competitor").val();
      sentNewDataToConnectedClients(competitorArrayIndex,competitorScore)
      showCompetitorForm("none");
    })

    //show up new competitor form
    function showCompetitorForm(option){
      $("#addCompetitor").click(function(){
        if(!option){
          $(".new-competitor-form").css("display","block")
        }
        else{
          $(".new-competitor-form").css("display","none")
        }
        console.log("adding new competitor..")
      })
    }


    //this function append all li to the ul tag
    function drawCompetitorsOnDom(competitors){
      if(competitors &&  competitors instanceof Array && competitors.length>0){
        //set the competitors from server
        competitorsList=competitors;
        var liElements="";
        var selectCompetitors="";

        for(c=0;c<competitors.length;c++){
          liElements+="<li class='competitor-"+c+"'>"+competitors[c].name+" "+competitors[c].lastName+"</li>";
          selectCompetitors+="<option value='"+c+"'>"+competitors[c].name+"</option>"
        }

        $(".competidores-list").append(liElements);
        $(".select-competitors").append(selectCompetitors);
      }
    }

    //get all competitors from server
    function getCompetitors(){
      $.ajax({
        type:'GET',
        url:"competidoresDb.php",
        dataType:'json',
        success:function(competitors){
          console.log("competitors from server",competitors)
          drawCompetitorsOnDom(competitors)
        },
        error:function(error){
          console.error("here error ",error);
        }

      })
    }

    //remember to connect through ssh and verify if the webSocket server is running on port 8080
    function connectToWebSocket(){
      conn = new WebSocket('ws://192.169.165.156:8080');
      conn.onopen = function(e) {
        console.log("Connected to webSocket!");
        //conn.send("hey nigga")
      };

      conn.onmessage = function(e) {
        var data=e.data;
         console.log("data",data)
        //var lele=JSON.parse(data);
        //console.log(typeof lele)
      };
    }

    function sentNewDataToConnectedClients(index,score){
      //set the object to update
      let competitorToUpdate={"score":score,"arrayIndex":index}
      //convert the json to string
      competitorToUpdate=JSON.stringify(competitorToUpdate);
      conn.send(competitorToUpdate)
    }
    //stablish connection with socket
    connectToWebSocket();
    //get competitors from server file
    getCompetitors();
    //handler to show up the new competitor form
    showCompetitorForm();
  </script>
</body>
</html>
